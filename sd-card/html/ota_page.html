<!DOCTYPE html>
<html lang="en" xml:lang="en">
<head>
    <meta charset="UTF-8">
    <title>OTA Update</title>

    <style>
        h1 {font-size: 1.8em;}
        h2 {font-size: 1.5em; margin-block-start: 0.0em; margin-block-end: 0.2em;}
        h3 {font-size: 1.2em;}
        p {font-size: 1em;}

        body, html {
            font-size: 100%;
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
                
        input[type=file] {
            width: 660px;
            padding: 5px 0px;
            display: inline-block;
            font-size: 16px; 
        }    
        
        .button {
            padding: 5px 10px;
            width: 205px;
            font-size: 16px;
        }
    </style>

    <script src="jquery-3.6.0.min.js?v=$COMMIT_HASH"></script>
    <link href="firework.css?v=$COMMIT_HASH" rel="stylesheet">
    <script src="firework.js?v=$COMMIT_HASH"></script>
</head>

<body style="font-family: arial; padding: 0px 10px; width:660px; max-width:660px;">
    <h2>OTA Update</h2>

    <p>The following file types are supported:</p>
    <ul>
        <li>*.zip &rarr; Content gets extracted to the SD card root folder</li>
        <li>*.bin &rarr; Firmware gets flashed to the device program flash</li>
        <li>*.tfl/tflite &rarr; Tensorflow models gets copied to your SD card/config folder</li>
    </ul>

    <br>

    <p><b>Recommended procedure to update the complete system:</b></p>
    <b>Use the <i>AI-on-the-edge-device__update__*.zip</i> file from the github project repository</b><br>
    Note: Using this, firmware + SD card gets updated, configuration remains unchanged

    <br>
    <br>

    <form id="upload_form" enctype="multipart/form-data" method="post">
        <input type="file" accept=".bin,.zip,.tfl,.tflite" name="file_selector" id="file_selector" onchange="validate_file()"><br><br>

        <button class="button" id="start_OTA_button" type="button" onclick="start_OTA()" disabled>Upload And Install</button>
        <br><br>
        <progress id="progressBar" value="0" max="100" style="width:600px;"></progress>
        <h3><span id="status">Status: Idle</span></h3>
        <p id="loaded_n_total"></p>
    </form>


<script src="common.js?v=$COMMIT_HASH"></script>
<script>
    var domainname = getDomainname();
    
    var action_runtime = 0;
    
    /* Max size of an individual file. Make sure this
    * value is same as that set in server_file.c */
    var MAX_FILE_SIZE = 8000*1024;
    var MAX_FILE_SIZE_STR = "8MB";
    
    function validate_file() {
        document.getElementById("start_OTA_button").disabled = true;

        var fileInput = document.getElementById("file_selector").files;
        var filepath = document.getElementById("file_selector").value;

        console.log("filepath: " + filepath);

        filename = filepath.split(/[\\\/]/).pop();

        console.log("filename: " + filename);

        /* Various checks on filename length and file size */
        if (fileInput.length == 0) {
            firework.launch('No file selected!', 'danger', 30000);
            return;
        } else if (filename.length == 0) {
            firework.launch('File path on server is not set!', 'danger', 30000);
            return;
        } else if (filename.length > 100) {
            firework.launch('Filename is too long! Max 100 characters.', 'danger', 30000);
            return;
        } else if (filename.indexOf(' ') >= 0) {
            firework.launch('Filename can not have spaces!', 'danger', 30000);
            return;
        } else if (filename[filename.length-1] == '/') {
            firework.launch('Filename not specified after path!', 'danger', 30000);
            return;
        } else if (fileInput[0].size > MAX_FILE_SIZE) {
            firework.launch("File size must be less than " + MAX_FILE_SIZE_STR + "!", 'danger', 30000);
            return;
        }

        /* Check if the fillename matches our expected pattern
            *  - AI-on-the-edge-device__update__*.zip
            *  - firmware__*.bin
            *  - *.ftl
            *  - *.tflite 
            *  - firmware.bin */
        if ( /(^AI-on-the-edge-device__update__)[a-zRC0-9()_\-.]*(\.zip$)/i.test(filename) || // OK
            ( /(^AI-on-the-edge-device__firmware)[a-zRC0-9()_\-.]*(\.bin$)/i.test(filename)) ||
            ( /[a-zRC0-9()_\-.]*(\.tfl$)/i.test(filename)) ||
            ( /[a-zRC0-9()_\-.]*(\.tflite$)/i.test(filename)) ||
                filename == "firmware.bin")
        {
            firework.launch("The selected file matches the expected name pattern. Press 'Upload and Install' to continue.", "success", 5000);
        }
        /* Following filenames are acceptiod but not prefered:
            * - *.bin
            * - *.zip */
        else if (filename.endsWith(".zip") || filename.endsWith(".bin")) { // Warning but still accepted
            firework.launch("The selected file does not fully match the expected name pattern. Press 'Upload and Install' to continue anyway.", "warning", 10000);
        }
        /* Any other file name format is not accepted */
        else { // invalid
            firework.launch("The selected file does not match the expected name pattern. 'Upload and Install' not possible.", "danger", 30000);
            return;
        }

        document.getElementById("start_OTA_button").disabled = false;
    }


    function start_OTA() {
        document.getElementById("start_OTA_button").disabled = true;

        var file_name = document.getElementById("file_selector").value;
        document.getElementById("file_selector").disabled = true;
        firework.launch('Do not reload this page or switch to another page while the update is in progress!', 'warning', 90000);
        file_name = file_name.split(/[\\\/]/).pop();
        document.getElementById("status").innerText = "Status: File selected";

        prepareOnServer();
    }


    function doRebootAfterUpdate() {
        var xhttp = new XMLHttpRequest();
        xhttp.open("GET", "/reboot", true);
        xhttp.send();
    }


    function prepareOnServer() {
        document.getElementById("status").innerText = "Status: Preparing device...";

        var xhttp = new XMLHttpRequest();

        var file_name = document.getElementById("file_selector").value;
        filePath = file_name.split(/[\\\/]/).pop();

        /* first delete the old firmware AND empty the /firmware directory*/	
        xhttp.onreadystatechange = function() {
            if (xhttp.readyState == 4) {
                if (xhttp.status == 200) {
                    /* keine Reaktion, damit sich das Dokument nicht Ã¤ndert */
                    upload();
                } else if (xhttp.status == 0) {
                    firework.launch('Server closed the connection abruptly!', 'danger', 30000);
                } else {
                    firework.launch('An error occured: ' + xhttp.responseText, 'danger', 30000);
                }
            }
        };

        var _toDo = domainname + "/ota?task=emptyfirmwaredir";
        xhttp.open("GET", _toDo, true);
        xhttp.send();
    }


    function extract() {
        document.getElementById("status").innerText = "Status: Processing on device...";

        var xhttp = new XMLHttpRequest();
        /* first delete the old firmware */	
        xhttp.onreadystatechange = function() {
            if (xhttp.readyState == 4) {
                if (xhttp.status == 200) {
                    document.cookie = "page=overview.html?v=$COMMIT_HASH;path=/;SameSite=Lax"; // Make sure after the reboot we go to the overview page

                    if (xhttp.responseText.startsWith("reboot")) { // Reboot required
                        console.log("Upload completed, the device will now restart and install the update!");
                        document.getElementById("status").innerText = "Status: Installing...";
                        firework.launch('Upload completed, the device will now restart and install the update', 'success', 5000);
                    
                        /* Tell it to reboot */
                        doRebootAfterUpdate();

                        action_runtime = 0;
                        updateTimer = setInterval(function() {                            
                            action_runtime += 1;
                            _("progressBar").value = Math.round(action_runtime);

                            if (action_runtime > 10) { // After 30 seconds, start to check if we are up again
                                /* Check if the device is up again and forward to index page if so */
                                fetch(getDomainname(), {mode: 'no-cors'})
                                    .then(r=>{
                                        parent.location.href=('index.html');
                                    });
                            }

                            if (action_runtime > 100) { // We reached 300 seconds but device is not ready yet
                                firework.launch("Reboot takes unusually long. Reload this page or power cycle the device", 'danger', 30000);
                                clearInterval(updateTimer);
                            }
                        }, 3000);                           
                    }
                    else // No reboot required
                    {
                        document.getElementById("status").innerText = "Status: Update completed";
                        firework.launch('Update completed!', 'success', 5000);
                        document.getElementById("file_selector").disabled = false;
                    }
                } else if (xhttp.status == 0) {
                    firework.launch('Server closed the connection abruptly!', 'danger', 30000);
                } else {
                    firework.launch('An error occured: ' + xhttp.responseText, 'danger', 30000);
                }
            }
        };

        var file_name = document.getElementById("file_selector").value;
        filePath = file_name.split(/[\\\/]/).pop();
        var _toDo = domainname + "/ota?task=update&file=" + filePath;
        xhttp.open("GET", _toDo, true);
        xhttp.send();
    }


    function _(el) {
        return document.getElementById(el);
    }


    function upload() {
        document.getElementById("status").innerText = "Status: Uploading...";

        var upload_path = "/upload/firmware/" + filePath;

        var file = _("file_selector").files[0];
        var formdata = new FormData();
        formdata.append("file_selector", file);
        var ajax = new XMLHttpRequest();
        ajax.upload.addEventListener("progress", progressHandler, false);
        ajax.addEventListener("load", completeHandler, false);
        ajax.addEventListener("error", errorHandler, false);
        ajax.addEventListener("abort", abortHandler, false);

        ajax.open("POST", upload_path);
        ajax.send(file);
    }


    function progressHandler(event) {
        _("loaded_n_total").innerHTML = "Uploaded " + (event.loaded / 1024 / 1024).toFixed(2) + 
                " MB of " + (event.total / 1024/ 1024).toFixed(2) + " MB";
        var percent = (event.loaded / event.total) * 100;
        _("progressBar").value = Math.round(percent);
        _("status").innerHTML = "Status: " + Math.round(percent) + "% uploaded. Please wait...";
    }


    function completeHandler(event) {
        _("status").innerHTML = "Status: " + event.target.responseText;
        _("progressBar").value = 0; //will clear progress bar after successful upload
        _("loaded_n_total").innerHTML = "";
    
        extract();
    }


    function errorHandler(event) {
        _("status").innerHTML = "Status: Upload Failed";
        firework.launch('Upload failed!', 'danger', 30000);
        document.getElementById("file_selector").disabled = false;
    }


    function abortHandler(event) {
        _("status").innerHTML = "Status: Upload Aborted";
        firework.launch('Upload aborted!', 'danger', 30000);
        document.getElementById("file_selector").disabled = false;
    }
</script>

</body>
</html> 
